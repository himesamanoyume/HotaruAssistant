name: Build realtime release
on:
  workflow_dispatch:
permissions:
  contents: write
jobs:
  build:
    name: Build
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          submodules: 'true'

      - name: Set up python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11.1'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pyinstaller

      - name: Generate program
        run: |
          pyinstaller -D --distpath .\dist\HotaruAssistant_v1.8.3 -i .\assets\logo\Hotaru.ico --contents-directory libraries --exclude-module PyQt5 --uac-admin -n 'Hotaru Assistant Client' --onefile main.py -y
          pyinstaller -D --distpath .\dist\HotaruAssistant_v1.8.3 -i .\assets\logo\Terminal.ico --contents-directory libraries --exclude-module PyQt5 --uac-admin -n 'Hotaru Assistant Register' --onefile reg.py -y
          pyinstaller -D --distpath .\dist\HotaruAssistant_v1.8.3 -i .\assets\logo\Terminal.ico --contents-directory libraries --exclude-module PyQt5 --uac-admin -n 'Hotaru Assistant Server' --onefile --add-data='templates;templates' --add-data='static;static' server.py -y
          pyinstaller -F --distpath .\dist\HotaruAssistant_v1.8.3 -i .\assets\logo\Update.ico -n 'Update' update.py -y

      - name: Move assets to dist directory
        run: |
          xcopy /E /I /Y .\assets\ .\dist\HotaruAssistant_v1.8.3\assets\
          xcopy /E /I /Y .\static\ .\dist\HotaruAssistant_v1.8.3\static\
          xcopy /Y .\README.md .\dist\HotaruAssistant_v1.8.3\
          xcopy /Y .\static\css\common.css .\dist\HotaruAssistant_v1.8.3\assets\css\

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: HotaruAssistant_${{ github.run_number }}
          path: ./dist/HotaruAssistant_v1.8.3
          retention-days: 1